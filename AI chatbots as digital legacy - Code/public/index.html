<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LuniBot ‚Äì Chat</title>
  <style>
    :root {
      --bg: #0b0b0d;
      --panel: #161616;
      --text: #eee;
      --muted: #aaa;
      --bubble-user: #2d3748;
      --bubble-assistant: #4b0f0f; /* dunkelrot */
      --border: #333;
      --accent: #8b5cf6;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg); color: var(--text);
      display:flex; justify-content:center; height:100vh;
    }
    .wrap {
      width:min(900px,100%); display:grid; grid-template-rows:auto 1fr auto; height:100vh;
    }
    header { padding:12px 16px; background:var(--panel); border-bottom:1px solid var(--border); }
    header h1 { margin:0; font-size:18px; }
    .chat { overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
    .msg { display:flex; }
    .msg.user { justify-content:flex-end; }
    .bubble {
      padding:12px 14px; border-radius:14px; line-height:1.4; border:1px solid var(--border);
      max-width:75%; white-space:pre-wrap; word-wrap:break-word;
    }
    .user .bubble { background: var(--bubble-user); }
    .assistant .bubble { background: var(--bubble-assistant); }
    .composer {
      display:grid; grid-template-columns:1fr auto auto; gap:8px;
      padding:12px; background:var(--panel); border-top:1px solid var(--border);
    }
    textarea {
      resize:none; min-height:48px; padding:12px; border-radius:12px; border:1px solid var(--border);
      background:#111; color:var(--text);
    }
    button {
      padding:0 16px; border-radius:12px; border:1px solid var(--border);
      background:var(--accent); color:#fff; cursor:pointer;
    }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    select {
      border-radius:8px; padding:6px 10px; background:#111; color:var(--text); border:1px solid var(--border);
    }
    .typing {
      font-size:12px; color:var(--muted); margin-left:8px;
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse {
      0% { opacity: .4; }
      50% { opacity: 1; }
      100% { opacity: .4; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>LuniBot</h1>
      <p style="margin:8px 16px;color:#aaa;font-size:12px">
        This is an unofficial clone of Luni's persona, created for research purposes. 
        It is not affiliated with or endorsed by Luni in any way. 
        The bot's knowledge is based on publicly available information and may not accurately reflect Luni's views or personality.
  By using this chat you consent to anonymous logging of your messages for research purposes.
</p>

    </header>

    <main id="chat" class="chat"></main>

    <div class="composer">
      <textarea id="input" placeholder="Let's go! (Shift+Enter = Zeilenumbruch)"></textarea>
      <select id="lang" title="Sprache">
        <option value="de" selected>Deutsch</option>
        <option value="en">English</option>
      </select>
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    // ---- API base ----
    const API = window.location.origin; //  http://127.0.0.1:8000

    // ---- Session Handling ----
    let sessionId = localStorage.getItem("luni_session");
    if (!sessionId) {
      sessionId = Math.random().toString(36).slice(2);
      localStorage.setItem("luni_session", sessionId);
    }

    // ---- DOM ----
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const langSel = document.getElementById('lang');

    // ---- Render helpers ----
    function addRow(role, text) {
      const row = document.createElement('div');
      row.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    let typingEl = null;
    function showTyping() {
      if (typingEl) return;
      typingEl = document.createElement('div');
      typingEl.className = 'msg assistant';
      typingEl.innerHTML = '<div class="bubble"><span class="typing">Lunibot is typing‚Ä¶</span></div>';
      chat.appendChild(typingEl);
      chat.scrollTop = chat.scrollHeight;
    }
    function hideTyping() {
      if (typingEl) { typingEl.remove(); typingEl = null; }
    }

    // ---- Send logic ----
    async function send() {
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      addRow('user', text);

      const lang = langSel.value;
      sendBtn.disabled = true;
      showTyping();

      try {
        const res = await fetch(`${API}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            lang: lang,
            session_id: sessionId,
            bubbles_by: "\n\n" // Server splits every two newlines
          }),
        });

        const j = await res.json();

        hideTyping();

        if (!res.ok) {
          addRow('assistant', j?.detail || '[Server-Fehler]');
          return;
        }

        // Render response, possibly in bubbles
   if (Array.isArray(j.bubbles) && j.bubbles.length) {
  let delay = 0;
  const step = 400; // ms zwischen den Bubbles
  j.bubbles.forEach((piece, idx) => {
    setTimeout(() => addRow('assistant', piece), delay);
    delay += step + piece.length * 10; 
    // Calcuklate delay based on length (10ms per char)
  });
} else {
  addRow('assistant', j.reply || '(keine Antwort)');
}
      } catch (err) {
        hideTyping();
        addRow('assistant', '[Netzwerkfehler: ' + (err?.message || err) + ']');
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // ---- Welcome bubble ----
    addRow('assistant', 'Hi, Lunibot speaking... ü¶ù ‚Äì Lets go! :D');
  </script>
</body>
</html>
